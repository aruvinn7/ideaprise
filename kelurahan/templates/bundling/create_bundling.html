{% extends "base/base.html" %}

{% block content %}
<div class="container mt-5">
  <h2 class="mb-4">Form Tambah Bundling</h2>
  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    

    <div class="mb-4">
      <label for="nama_bundling" class="form-label">Nama</label>
      <input type="text" id="nama_bundling" name="nama_bundling" class="form-control" required>
    </div>

    <div class="mb-4">
      <label for="gambar_bundling" class="form-label">Gambar</label>
      <input type="file" id="gambar_bundling" name="gambar_bundling" class="w-full border rounded p-4" accept="image/*" required>
    </div>

    <div class="mb-4">
      <label for="thumbnail_crop" class="form-label">Thumbnail Produk (1:1)</label>
      <input type="file" id="thumbnail_crop" accept="image/*" class="w-full border rounded p-4" required>
      <input type="hidden" name="thumbnail_base64" id="thumbnail_base64" required>
    </div>

    <!-- Modal Crop -->
    <div id="cropModal" style="display:none; position:fixed; z-index:9999; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center;">
      <div style="background:white; padding:20px; border-radius:10px; max-width:90vw; max-height:90vh;">
        <div style="max-height: 70vh; overflow:auto;">
          <img id="cropImage" style="max-width: 100%; display:block;">
        </div>
        <div style="text-align:right; margin-top:10px;">
          <button type="button" id="cropSave" class="btn btn-primary">Crop & Upload</button>
          <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Thumbnail Preview -->
    <div class="mb-3 mt-3">
      <img id="thumbnail_preview" style="max-width: 200px; border:1px solid #ccc;" />
    </div>

    <div class="mb-4">
      <label for="deskripsi_bundling" class="form-label">Deskripsi</label>
      <input type="text" id="deskripsi_bundling" name="deskripsi_bundling" class="form-control" required>
    </div>

    <div class="mb-4">
      <label for="harga_bundling" class="form-label">Harga</label>
      <input type="number" id="harga_bundling" name="harga_bundling" class="form-control" required>
    </div>

    <div class="mb-4">
      <label for="link_shopee" class="form-label">Link Shopee</label>
      <input type="url" id="link_shopee" name="link_shopee" class="form-control" required>
    </div>
    <div class="mb-4">
      <label for="link_tokopedia" class="form-label">Link Tokopedia</label>
      <input type="url" id="link_tokopedia" name="link_tokopedia" class="form-control" required>
    </div>

    <div class="row mb-4">
        <div class="col-auto">
            <button type="button" class="btn btn-inverse-success" onclick="tambahdetail()">Tambah</button>
        </div>
    </div>

    <div class="mb-4" id="tambahdetail">
        <div class="detail-row card shadow-sm p-4 mb-3">
            <h5 class="card-title">Detail Bundling 1</h5>
            <div class="form-group row">
                <label for="produk" class="col-sm-3 col-form-label">Produk</label>
                <div class="col-sm-9">
                    <select class="form-control" name="produk" required>
                        {% for i in produkobj %}
                        <option value="{{ i.id_produk }}">{{ i }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div><br>
            <button class="btn btn-inverse-danger" type="button" onclick="deleterow(this)">Delete</button>
        </div>
    </div>

    <div class="mb-4">
        <button type="submit" class="btn btn-primary">Kirim</button>
    </div>

  </form>
</div>


{% block javascripts %}

<!-- CropperJS CSS & JS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
let cropper;
const thumbnailInput = document.getElementById('thumbnail_crop');
const cropModal = document.getElementById('cropModal');
const cropImage = document.getElementById('cropImage');
const thumbnailBase64 = document.getElementById('thumbnail_base64');
const thumbnailPreview = document.getElementById('thumbnail_preview');

// Buka modal ketika input gambar berubah
thumbnailInput.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(event) {
    cropImage.src = event.target.result;
    cropModal.style.display = 'flex';

    if (cropper) cropper.destroy();
    cropper = new Cropper(cropImage, {
      aspectRatio: 1,
      viewMode: 1,
      autoCropArea: 1,
      movable: true,
      zoomable: true,
      responsive: true
    });
  };
  reader.readAsDataURL(file);
});

// Tombol simpan hasil crop
document.getElementById('cropSave').addEventListener('click', function () {
  if (!cropper) return;

  const canvas = cropper.getCroppedCanvas({ width: 400, height: 400 });
  const base64 = canvas.toDataURL('image/jpeg');

  thumbnailBase64.value = base64;
  thumbnailPreview.src = base64;

  closeModal();
});

// Tutup modal
function closeModal() {
  cropModal.style.display = 'none';
  if (cropper) cropper.destroy();
}
</script>

<script>
    function tambahdetail() {
        const rows = document.querySelectorAll('#tambahdetail .detail-row');
        const angka = rows.length + 1;
        const baris = document.createElement('div');
        baris.className = 'detail-row card shadow-sm p-4 mb-3'; // Add margin bottom for spacing
        baris.innerHTML = `
            <h5 class="card-title">Detail Bundling 1</h5>
            <div class="form-group row">
                <label for="produk" class="col-sm-3 col-form-label">Produk</label>
                <div class="col-sm-9">
                    <select class="form-control" name="produk" required>
                        {% for i in produkobj %}
                        <option value="{{ i.id_produk }}">{{ i }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div><br>
            <button class="btn btn-inverse-danger" type="button" onclick="deleterow(this)">Delete</button>
        `;
        document.getElementById('tambahdetail').appendChild(baris);
        updateRowNumbers();
    }

    function deleterow(button) {
        button.closest('.detail-row').remove();
        updateRowNumbers();
    }

    function updateRowNumbers() {
        const rows = document.querySelectorAll('#tambahdetail .detail-row');
        rows.forEach((row, index) => {
            const title = row.querySelector('h5');
            title.textContent = `Detail Bundling ${index + 1}`;

        });
    }
</script>

{% endblock javascripts %}
{% endblock content %}