{% extends "base/base.html" %}

{% block content %}
<div class="hero" style="background: linear-gradient(to right, #023E8A, #00B4D8); padding: 2rem 0; color: white; margin-bottom: 3rem;">
  <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 0 20px;">
    <h1 style="color: white; margin: 0; font-size: 2.5rem;">Produk</h1>    
  </div>    
</div>

<div class="container mt-5">
  <h2 class="mb-4">Form Tambah Produk</h2>
  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    
    <!-- Kategori -->
    <div class="mb-3">
      <label for="id_kategori" class="form-label">Kategori</label>
      <select name="id_kategori" id="id_kategori" class="form-select">
        <option value="">Pilih Kategori</option>
        {% for i in kategoriobj %}
          <option value="{{ i.id_kategori }}">{{ i.nama_kategori }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Nama Produk -->
    <div class="mb-4">
      <label for="nama_produk" class="form-label">Nama</label>
      <input type="text" id="nama_produk" name="nama_produk" class="form-control" required>
    </div>
    
    <!-- Nomor Telepon -->
    <div class="mb-4">
      <label for="nomor_telepon" class="form-label">Nomor Telepon</label>
      <input type="tel" id="nomor_telepon" name="nomor_telepon" class="form-control" required>
    </div>

    <!-- Gambar Produk -->
    <div class="mb-4">
      <label for="gambar_produk" class="form-label">Gambar Produk</label>
      <input type="file" id="gambar_produk" name="gambar_produk" accept="image/*" class="w-full border rounded p-4" required>
    </div>

    <!-- Thumbnail Crop Upload -->
    <div class="mb-4">
      <label for="thumbnail_crop" class="form-label">Thumbnail Produk (1:1)</label>
      <input type="file" id="thumbnail_crop" accept="image/*" class="w-full border rounded p-4">
      <input type="hidden" name="thumbnail_base64" id="thumbnail_base64">
    </div>

    <!-- Modal Crop -->
    <div id="cropModal" style="display:none; position:fixed; z-index:9999; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center;">
      <div style="background:white; padding:20px; border-radius:10px; max-width:90vw; max-height:90vh;">
        <div style="max-height: 70vh; overflow:auto;">
          <img id="cropImage" style="max-width: 100%; display:block;">
        </div>
        <div style="text-align:right; margin-top:10px;">
          <button type="button" id="cropSave" class="btn btn-primary">Crop & Upload</button>
          <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Thumbnail Preview -->
    <div class="mb-3 mt-3">
      <img id="thumbnail_preview" style="max-width: 200px; border:1px solid #ccc;" />
    </div>

    <!-- Deskripsi -->
    <div class="mb-4">
      <label for="deskripsi_produk" class="form-label">Deskripsi</label>
      <input type="text" id="deskripsi_produk" name="deskripsi_produk" class="form-control" required>
    </div>

   <!-- Link Shopee -->
    <div class="mb-4">
      <label for="link_shopee" class="form-label">Link Shopee</label>
      <input type="url" id="link_shopee" name="link_shopee" class="form-control">
    </div>

    <!-- Link Tokopedia -->
    <div class="mb-4">
      <label for="link_tokopedia" class="form-label">Link Tokopedia</label>
      <input type="url" id="link_tokopedia" name="link_tokopedia" class="form-control">
    </div>

    <!-- Harga -->
    <div class="mb-4">
      <label for="harga_produk" class="form-label">Harga</label>
      <input type="number" id="harga_produk" name="harga_produk" step="0.01" class="form-control" required>
    </div>

    <!-- Submit -->
    <div class="mb-4">
        <button type="submit" class="btn btn-primary">Kirim</button>
    </div>
  </form>
</div>

<!-- CropperJS CSS & JS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
let cropper;
const thumbnailInput = document.getElementById('thumbnail_crop');
const cropModal = document.getElementById('cropModal');
const cropImage = document.getElementById('cropImage');
const thumbnailBase64 = document.getElementById('thumbnail_base64');
const thumbnailPreview = document.getElementById('thumbnail_preview');

// Buka modal ketika input gambar berubah
thumbnailInput.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(event) {
    cropImage.src = event.target.result;
    cropModal.style.display = 'flex';

    if (cropper) cropper.destroy();
    cropper = new Cropper(cropImage, {
      aspectRatio: 1,
      viewMode: 1,
      autoCropArea: 1,
      movable: true,
      zoomable: true,
      responsive: true
    });
  };
  reader.readAsDataURL(file);
});

// Tombol simpan hasil crop
document.getElementById('cropSave').addEventListener('click', function () {
  if (!cropper) return;

  const canvas = cropper.getCroppedCanvas({ width: 400, height: 400 });
  const base64 = canvas.toDataURL('image/jpeg');

  thumbnailBase64.value = base64;
  thumbnailPreview.src = base64;

  closeModal();
});

// Tutup modal
function closeModal() {
  cropModal.style.display = 'none';
  if (cropper) cropper.destroy();
}
</script>
{% endblock content %}
